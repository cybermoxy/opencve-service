<p align="center">
  <img alt="OpenCVE" src="https://raw.githubusercontent.com/opencve/opencve/master/logo.png">
</p>

## Set up OpenCVE Docker

The official documentation is provided [here](https://docs.opencve.io/installation/docker/), but we don't need all of them. Below we condense the steps and only configure the things we need.

Note that PostgrSQL is included in the original `docker-compose.yml`, but since we will run the database on its own, it is removed from the file.

Also note that the initial data import requires **at least 5 GB of memory** on the machine hosting the docker container. But once the initial data import is complete, subsequent update uses very little memory.

1. Change the filename `conf/opencve.cfg.example` to `conf/opencve.cfg`
2. Inside `conf/opencve.cfg`, change `server_name` to `0.0.0.0:8000`
3. Inside `conf/opencve.cfg`, give a value to `secret_key` according to [Flask recommendation](https://flask.palletsprojects.com/en/1.1.x/config/#SECRET_KEY). We are not using the Flask app, but this secret key is required.
4. Inside `conf/opencve.cfg`, change `database_uri` to the external PostgreSQL. The PostgreSQL database should already be set up, with `user=opencve`, `db=opencve`, and the corresponding password and host endpoint. The final `database_uri` shall look like this
    ```
    postgresql://opencve:<password>@<host_endpoitn>:5432/opencve
    ```
5. While under the root of `opencve-docker` folder, run the following command to build the image
    ```bash
    docker-compose build
    ```
    If you are on Apple silicon, run
    ```bash
    DOCKER_DEFAULT_PLATFORM=linux/amd64 docker-compose build
    ```
6. Initialize the stack
    ```
    docker-compose up -d redis webserver celery_worker
    ```
7. Initialize the database
    ```
    docker exec -it webserver opencve upgrade-db
    ```
8. Import data

    This step can take a few minutes, and will fail if there is not enough memory on the container host machine.
    ```
    docker exec -it webserver opencve import-data
    ```

9. Start periodic update task with Celery beat
    ```
    docker-compose up -d celery_beat
    ```